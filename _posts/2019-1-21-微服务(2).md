---
layout: post
title:  微服务基础(2)
date:   2019-1-21 00:00:00 +0800
categories: 微服务
tag: 微服务
---

* content
{:toc}


### 微服务数据库独立
1. 在单体结构中所有业务都是使用一个数据库，但是随着业务的增加，所有表公用一个库，多表难以维护和管理，数据量增加导致查询速度变慢
2. 微服务依据业务划分服务，每个服务运行在自己的进程中，而且每个服务都有自己独立的数据库，即使业务增加，只需要服务之间接口调用，不需要进行
      数据库集成。
3. 数据库独立便于以后迁移数据库。如下图
![image](https://beautifulgirlzhangxiaogui.top/styles/images/2.png)

### 微服务自动化部署及管理
1. 微服务系统中，整个系统会被拆分为若干个服务，每个服务是一个独立运行的程序，单体系统只需要部署一次，而微服务有多少个服务就需要部署多少次
2. Docker容器部署微服务，Jenkins自动部署
3. 微服务需要进行集中化管理，SpringCloud的Eureka注册服务发现服务，Zookeeper、Consul等
4. 分布式系统是由集群部署的，由很多台服务器共同完成用户请求，分布式系统是通过网络协议进行通信的，因此分布式系统在哪部署都可以(不用区分地区和机房)。 
### 解决微服务中的雪崩效应--熔断机制
1. 由于微服务是分布式架构，需要考虑服务的独立性和相互调用的可靠性，以及分布式事务、全局锁、全局ID。
2. 分布式系统集群化部署会给数据的一致性带来问题，由于服务与服务之间是通过通讯协议通信的，如果网络不好将会对系统产生影响。
3. 分布式系统中服务与服务之间相互依赖，如果出现网络延迟或者单个服务出现问题，在高并发的情况下就会导致线程阻塞，在极短的时间内该服务的线程资源就会消耗  完，最终导致该服务不能用，因为服之间是依赖的，因此导致整个系统不可用，这就是雪崩效应。
4. 为防止雪崩效应、采用熔断机制
### 熔断机制
   举个栗子，例如在微服务系统中，存在abcdefgh等多个服务，用户的请求通过网关后，再到具体服务，服务之间相互依赖，例如服务b依赖服务f，一个对外暴露的接口api需要服务b、f相互协同才能完成工作，如下图。
   ![image](https://beautifulgirlzhangxiaogui.top/styles/images/4.png)
   * 假设服务b出现故障或者网络出现延迟，而且此时处于高并发状态，服务b就会出现大量的线程阻塞，有可能在很短时间内线程资源就会被消耗完，进而导致服务b不可用。
   * 如果服务b为较底层服务，或者与b服务相互依赖的服务很多，进而影响到其他服务，导致其他服务会一直等待服务b，如果服务b很长时间不进行处理，大量网络请求堆积在服务b和与服务b相互依赖的其他服务，所有服务b出现故障导致依赖于服务b的服务出现故障，进而导致整个系统不可用。由于服务运行商和网络服务商的不可靠导致服务的不可靠，又故障的传播性，导致大量服务不可用，最终系统崩溃。
   * 因此出现的熔断机制：当服务b出现故障，请求失败次数超过设定阈值，服务b就会启动熔断器，之后服务b不进行任何逻辑操作，快速执行失败，直接返回请求失败的信息，依赖于服务b的其他服务也不会因为得不到响应而出现线程阻塞。此时只有服务b和依赖服务b的其他服务不可用，其他服务正常运行，如下图。
   ![image](https://beautifulgirlzhangxiaogui.top/styles/images/5.png)
   * 熔断器还有另外一个机制，就是自我修复机制。当服务b熔断后，一段时间后，半打开熔断器，半打开的熔断器会检查部分请求是否正常，其他的请求快速执行失败，检查的请求如果响应成功，则可以判断服务b可以使用进而关闭熔断器，如果服务b不正常，继续打开熔断器。
   * 熔断器提供了很多监控，服务器是否可用、熔断器是否打开、目前的吞吐量、网络延迟状态。
### 微服务优劣势
